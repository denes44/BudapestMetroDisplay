###################################################
# BudapestMetroDisplay ESPHOME created by denes44 #
# https://github.com/denes44/BudapestMetroDisplay #
# Core functionately                              #
###################################################

# ESPHome & Board

esphome:
  name: ${name}
  friendly_name: ${friendly_name}
  project:
    name: "denes44.BudapestMetroDisplay"
    version: 0.1.2
  platformio_options:
    board_build.flash_mode: dio
  on_boot:
    priority: -100
    then:
      - script.execute: default_values
      - text_sensor.template.publish:
          id: fw_version_installed
          state: !lambda 'return to_string(ESPHOME_PROJECT_VERSION);'

esp32:
  board: adafruit_feather_esp32s3
  framework:
    type: esp-idf
    version: recommended

logger:

text_sensor:
  - platform: template
    name: Installed firmware version
    id: fw_version_installed
    entity_category: diagnostic
    web_server_sorting_weight: 1
    update_interval: never

  - platform: template
    name: Latest firmware version
    id: fw_version_latest
    entity_category: diagnostic
    web_server_sorting_weight: 2
    update_interval: never

interval:
  - interval: 1d
    then:
      if:
        condition:
          wifi.connected:
        then:
          - script.execute: get_latest_version


# WiFi, AP, Network, etc.

wifi:
  # Enable fallback hotspot (captive portal) in case wifi connection fails
  ap:
    ssid: ${friendly_name} Fallback AP

  on_connect:
    then:
      - script.execute: get_latest_version

captive_portal:

ota:
  - platform: esphome
    id: esphome_ota_component
  - platform: http_request
    id: http_ota_component

http_request:


# Home Assistant API

api:

time:
  - platform: homeassistant
    id: homeassistant_time


# Built in web server

web_server:
  port: 80
  ota: false
  version: 3


# Generic sensors and buttons

button:
  - platform: restart
    name: Restart
    id: _restart
    entity_category: config
    web_server_sorting_weight: 3

  - platform: safe_mode
    name: Restart (Safe Mode)
    id: _restart_safe
    entity_category: config
    web_server_sorting_weight: 4

  - platform: shutdown
    name: Shutdown
    id: _shutdown
    entity_category: config
    web_server_sorting_weight: 5

  - platform: template
    name: OTA Update
    id: ota_switch
    entity_category: config
    web_server_sorting_weight: 2
    on_press:
      then:
        - ota.http_request.flash:
            url: https://raw.githubusercontent.com/denes44/BudapestMetroDisplay/refs/heads/main/esphome/firmware/firmware_latest.ota.bin
            md5_url: https://raw.githubusercontent.com/denes44/BudapestMetroDisplay/refs/heads/main/esphome/firmware/firmware_latest.ota.md5

sensor:
  - platform: wifi_signal
    name: Wifi
    id: wifi_signal_strength
    update_interval: 60s
    entity_category: diagnostic
    web_server_sorting_weight: 4
    filters:
    - sliding_window_moving_average:
        window_size: 15
        send_every: 15

# Light, sensors and other stuff for the hardware

light:
  - platform: esp32_rmt_led_strip
    name: ${friendly_name}
    id: leds
    web_server_sorting_weight: 1
    restore_mode: RESTORE_DEFAULT_OFF
    pin: GPIO07
    num_leds: 63
    rmt_channel: 0
    chipset: SK6812
    rgb_order: GRB

    effects:
      - addressable_color_wipe:
          name: LED Test
          colors:
            - red: 100%
              green: 0%
              blue: 0%
              num_leds: 63
            - red: 100%
              green: 100%
              blue: 0%
              num_leds: 63
            - red: 0%
              green: 100%
              blue: 0%
              num_leds: 63
            - red: 0%
              green: 100%
              blue: 100%
              num_leds: 63
            - red: 0%
              green: 0%
              blue: 100%
              num_leds: 63
            - red: 100%
              green: 0%
              blue: 100%
              num_leds: 63
            - red: 100%
              green: 100%
              blue: 100%
              num_leds: 63
          add_led_interval: 50ms
          reverse: false
      - e131:
          universe: 1
          channels: RGB

e131:
  method: multicast

switch:
  - platform: template
    name: LED Test
    id: led_test
    optimistic: true
    web_server_sorting_weight: 1
    entity_category: config
    turn_on_action:
      - light.turn_off:
          id: leds
          transition_length: 0s
      - delay: 1s
      - light.turn_on:
          id: leds
          effect: LED Test
    turn_off_action:
      - script.execute: default_values

binary_sensor:
  - platform: gpio
    pin:
      number: GPIO0
      mode:
        input: true
        pullup: true
    id: button_boot
    on_press:
      - switch.toggle: led_test

  - platform: status
    name: Status
    web_server_sorting_weight: 3
    entity_category: diagnostic

script:
  - id: default_values
    then:
      - light.turn_off:
          id: leds
          transition_length: 0s
      - delay: 10ms
      - light.addressable_set: #H6
          id: leds
          range_from: 0
          range_to: 2
          red: 50%
          green: 29%
          blue: 0%
          color_brightness: 20%
      - delay: 10ms
      - light.addressable_set: #H7
          id: leds
          range_from: 3
          range_to: 5
          red: 92%
          green: 44%
          blue: 1%
          color_brightness: 20%
      - delay: 10ms
      - light.addressable_set: #M4/1
          id: leds
          range_from: 6
          range_to: 11
          red: 28%
          green: 65%
          blue: 25%
          color_brightness: 20%
      - delay: 10ms
      - light.addressable_set: #M4/2
          id: leds
          range_from: 13
          range_to: 14
          red: 28%
          green: 65%
          blue: 25%
          color_brightness: 20%
      - delay: 10ms
      - light.addressable_set: #M2/1
          id: leds
          range_from: 15
          range_to: 16
          red: 89%
          green: 12%
          blue: 9%
          color_brightness: 20%
      - delay: 10ms
      - light.addressable_set: #M2/2
          id: leds
          range_from: 18
          range_to: 18
          red: 89%
          green: 12%
          blue: 9%
          color_brightness: 20%
      - delay: 10ms
      - light.addressable_set: #M2/3
          id: leds
          range_from: 20
          range_to: 21
          red: 89%
          green: 12%
          blue: 9%
          color_brightness: 20%
      - delay: 10ms
      - light.addressable_set: #M2/4
          id: leds
          range_from: 23
          range_to: 24
          red: 0%
          green: 0%
          blue: 0%
          color_brightness: 20%
      - delay: 10ms
      - light.addressable_set: #H9
          id: leds
          range_from: 26
          range_to: 26
          red: 92%
          green: 46%
          blue: 43%
          color_brightness: 20%
      - delay: 10ms
      - light.addressable_set: #H5
          id: leds
          range_from: 27
          range_to: 34
          red: 50%
          green: 6%
          blue: 40%
          color_brightness: 20%
      - delay: 10ms
      - light.addressable_set: #M3
          id: leds
          range_from: 35
          range_to: 52
          red: 0%
          green: 35%
          blue: 64%
          color_brightness: 20%
      - delay: 10ms
      - light.addressable_set: #M1
          id: leds
          range_from: 53
          range_to: 62
          red: 100%
          green: 85%
          blue: 0%
          color_brightness: 20%
      - delay: 10ms
      - light.addressable_set: #M4/M3 Kálvin tér
          id: leds
          range_from: 12
          range_to: 12
          red: 0%
          green: 100%
          blue: 100%
          color_brightness: 20%
      - delay: 10ms
      - light.addressable_set: #M2/H5 Batthány tér
          id: leds
          range_from: 17
          range_to: 17
          red: 100%
          green: 60%
          blue: 0%
          color_brightness: 20%
      - delay: 10ms
      - light.addressable_set: #M1/M2/M3 Deák Ferenc tér
          id: leds
          range_from: 19
          range_to: 19
          red: 100%
          green: 100%
          blue: 100%
          color_brightness: 20%
      - delay: 10ms
      - light.addressable_set: #M2/M4 Keleti pályaudvar
          id: leds
          range_from: 22
          range_to: 22
          red: 100%
          green: 35%
          blue: 0%
          color_brightness: 20%
      - delay: 10ms
      - light.addressable_set: #M2/H9 Örs vezér tere
          id: leds
          range_from: 25
          range_to: 25
          red: 91%
          green: 28%
          blue: 26%
          color_brightness: 20%
      - delay: 1s
      - light.turn_on:
          id: leds
          effect: E1.31

  - id: get_latest_version
    then:
      - http_request.get:
          url: https://raw.githubusercontent.com/denes44/test/refs/heads/dev/esphome/firmware/metro-display-esp32s3_latest.txt
          capture_response: true
          on_response:
            - if:
                condition:
                    lambda: |-
                      return response->status_code == 200;
                then:
                  - lambda: |-
                      id(fw_version_latest).publish_state(body);
