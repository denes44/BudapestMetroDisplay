name: ESPHome Publish

on:
  pull_request:
    types: [closed]
    branches: [main]
    paths:
      - esphome/**/*.yaml
  workflow_dispatch:

jobs:
  build-firmware:
    name: Build Firmware
    runs-on: ubuntu-latest
    permissions:
      contents: write
    if: >
      github.event_name == 'workflow_dispatch' ||
      (
        github.event_name == 'pull_request' &&
        github.event.action == 'closed' &&
        github.event.pull_request.merged == true &&
        startsWith(github.event.pull_request.head.ref, 'esphome-')
      )
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Build Firmware
        uses: esphome/build-action@v6
        id: esphome-build
        with:
          yaml-file: esphome/metro-display.factory.yaml
          complete-manifest: true
          cache: true

      - name: Upload firmware artifacts
        uses: actions/upload-artifact@v4
        with:
          name: firmware-${{ steps.esphome-build.outputs.project-version }}
          path: |
            ${{ steps.esphome-build.outputs.name }}/${{ steps.esphome-build.outputs.name }}.factory.bin
            ${{ steps.esphome-build.outputs.name }}/${{ steps.esphome-build.outputs.name }}.ota.bin
            ${{ steps.esphome-build.outputs.name }}/manifest.json

  extract_release_notes:
    name: Extract release notes for release
    runs-on: ubuntu-latest
    needs: esphome_build
    outputs:
      notes: ${{ steps.extract_notes.outputs.notes }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
      - name: Extract release notes from CHANGELOG
        id: extract_notes
        shell: bash
        run: |
          set -euo pipefail

          VERSION="${{ needs.esphome_build.outputs.project_version }}"
          CHANGELOG="esphome/CHANGELOG.md"

          # Stream-normalize CRLF and extract the section for the version:
          NOTES="$(tr -d '\r' < "$CHANGELOG" | awk -v ver="$VERSION" '
            BEGIN { found=0 }
            /^## \[/ {
              if (found) exit 0
              if ($0 ~ "^## \\[" ver "\\]") { found=1; print; next }
              next
            }
            found { print }
          ')"

          if [[ -z "$NOTES" ]]; then
            echo "âŒ Version '$VERSION' not found in $CHANGELOG" >&2
            exit 1
          fi

          {
            echo "notes<<'EOF_NOTES'"
            printf "%s\n" "$NOTES"
            echo "EOF_NOTES"
          } >> "$GITHUB_OUTPUT"

  create_release:
    name: Create GitHub Release
    needs: extract_release_notes
    runs-on: ubuntu-latest
    steps:
      - name: Download firmware artifacts
        uses: actions/download-artifact@v4
        with:
          name: firmware-${{ needs.build-firmware.outputs.project_version }}
          path: ./release-assets

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: esphome-${{ needs.build-firmware.outputs.project_version }}
          name: esphome-${{ needs.build-firmware.outputs.project_version }}
          body: ${{ needs.extract_release_notes.outputs.notes }}
          files: |
            release-assets/${{ needs.build-firmware.outputs.project_name }}.factory.bin
            release-assets/${{ needs.build-firmware.outputs.project_name }}.ota.bin
            release-assets/manifest.json
